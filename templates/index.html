{% extends 'base.html' %}

{% block content %}
<div class="modern-layout">
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-section">
            <h3 class="sidebar-title">üìä {{ t('stats_title') }}</h3>
            
            <!-- Period Selector -->
            <div class="period-selector">
                <button class="period-btn active" data-period="day" onclick="changePeriod('day')">–î–µ–Ω—å</button>
                <button class="period-btn" data-period="week" onclick="changePeriod('week')">–ù–µ–¥–µ–ª—è</button>
                <button class="period-btn" data-period="month" onclick="changePeriod('month')">–ú–µ—Å—è—Ü</button>
            </div>
            
            <!-- Main Stats -->
            <div class="stats-grid">
                <div class="stat-card" data-stat="total">
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card" data-stat="done">
                    <div class="stat-value" id="doneTasks">0</div>
                    <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
            </div>
            
            <!-- Status Chart -->
            <div class="chart-wrapper">
                <canvas id="statusChart"></canvas>
            </div>
            
            <!-- Priority Chart -->
            <div class="chart-wrapper">
                <h4 class="chart-title">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</h4>
                <canvas id="priorityChart"></canvas>
            </div>
        </div>
        
        <!-- Top Productive Periods -->
        <div class="sidebar-section">
            <h3 class="sidebar-title">üèÜ {{ t('top_days') }}</h3>
            <div id="topPeriodsList" class="top-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
        
        <!-- Productivity Chart -->
        <div class="sidebar-section">
            <h3 class="sidebar-title">üìà {{ t('productivity_chart') }}</h3>
            <div class="chart-wrapper">
                <canvas id="productivityChart"></canvas>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="content-header">
            <h1 class="page-title">‚ú® {{ t('my_tasks') }}</h1>
            <button class="add-task-trigger" onclick="toggleAddForm()">
                <span class="add-icon">+</span>
                <span>{{ t('add_task') }}</span>
            </button>
        </div>
        
        <!-- Add Task Form -->
        <div class="add-task-panel" id="addTaskPanel" style="display: none;">
            <form id="addTaskForm" class="task-form">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="form-input form-textarea"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                            <select name="priority" class="form-select">
                                <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                                <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
                            <input type="date" name="deadline" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <button type="button" class="subtask-toggle" onclick="toggleSubtasks()">
                            <span>+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏</span>
                        </button>
                        <div id="subtasksContainer" style="display: none;" class="subtasks-input">
                            <div id="subtasksList">
                                <input type="text" class="form-input subtask-input" placeholder="–ü–æ–¥–∑–∞–¥–∞—á–∞ 1">
                                <input type="text" class="form-input subtask-input" placeholder="–ü–æ–¥–∑–∞–¥–∞—á–∞ 2">
                            </div>
                            <button type="button" class="btn-link" onclick="addSubtaskInput()">+ –ï—â–µ –ø–æ–¥–∑–∞–¥–∞—á–∞</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span>‚úì –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="toggleAddForm()">
                        <span>–û—Ç–º–µ–Ω–∞</span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Tasks List -->
        <div class="tasks-container" id="tasksContainer">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</p>
            </div>
        </div>
    </main>
</div>

<script>
let currentPeriod = 'day';
let charts = {};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    loadTasks();
    loadStats(currentPeriod);
    setupFormHandler();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
async function loadTasks() {
    try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        renderTasks(tasks);
    } catch (error) {
        console.error('Error loading tasks:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á
function renderTasks(tasks) {
    const container = document.getElementById('tasksContainer');
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìã</div>
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</p>
                <button class="btn btn-primary" onclick="toggleAddForm()">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = tasks.map(task => `
        <div class="task-card ${task.computed_status}" data-task-id="${task.id}">
            <div class="task-card-header">
                <input type="checkbox" class="task-checkbox" 
                       ${task.computed_status === 'done' ? 'checked' : ''}
                       onchange="toggleTask(${task.id})">
                <div class="task-info">
                    <h3 class="task-title">${task.title}</h3>
                    ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                    <div class="task-meta">
                        <span class="meta-item">
                            <span class="meta-icon">üìÖ</span>
                            <span>${formatDate(task.created_at)}</span>
                        </span>
                        ${task.deadline ? `
                            <span class="meta-item">
                                <span class="meta-icon">‚è∞</span>
                                <span>${task.deadline}</span>
                            </span>
                        ` : ''}
                        <span class="priority-badge priority-${task.priority || 'medium'}">
                            ${getPriorityLabel(task.priority || 'medium')}
                        </span>
                    </div>
                </div>
                <button class="task-delete" onclick="deleteTask(${task.id})" title="–£–¥–∞–ª–∏—Ç—å">
                    <span>√ó</span>
                </button>
            </div>
            
            ${task.subtasks && task.subtasks.length > 0 ? `
                <div class="subtasks-section">
                    <div class="subtasks-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${getProgressPercent(task.subtasks)}%"></div>
                        </div>
                        <span class="progress-text">${getCompletedCount(task.subtasks)}/${task.subtasks.length}</span>
                    </div>
                    <div class="subtasks-list">
                        ${task.subtasks.map(sub => `
                            <div class="subtask-item ${sub.status === 'done' ? 'completed' : ''}">
                                <input type="checkbox" ${sub.status === 'done' ? 'checked' : ''}
                                       onchange="toggleSubtask(${sub.id})">
                                <span>${sub.title}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `).join('');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function loadStats(period) {
    try {
        const response = await fetch(`/api/stats/${period}`);
        const data = await response.json();
        updateStats(data);
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats(data) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —á–∏—Å–ª–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    animateValue('totalTasks', data.total);
    animateValue('doneTasks', data.status.done);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    updateStatusChart(data.status);
    updatePriorityChart(data.priorities);
    updateProductivityChart(data.productivity);
    updateTopPeriods(data.top_periods);
}

// –ê–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–µ–ª (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ - –±–µ–∑ –ø—Ä—ã–∂–∫–æ–≤)
function animateValue(id, end, duration = 500) {
    const element = document.getElementById(id);
    const start = parseInt(element.textContent) || 0;
    
    if (start === end) return; // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –Ω–µ –∞–Ω–∏–º–∏—Ä—É–µ–º
    
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
        }
        element.textContent = Math.round(current);
    }, 16);
}

// –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤
function updateStatusChart(status) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (charts.status) {
        charts.status.data.datasets[0].data = [status.not_started, status.in_progress, status.done];
        charts.status.update('active');
    } else {
        charts.status = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['–ù–µ –Ω–∞—á–∞—Ç–æ', '–í –ø—Ä–æ—Ü–µ—Å—Å–µ', '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'],
                datasets: [{
                    data: [status.not_started, status.in_progress, status.done],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(251, 191, 36, 0.8)',
                        'rgba(34, 197, 94, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-primary'),
                            padding: 10,
                            font: { size: 11 }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    }
}

// –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
function updatePriorityChart(priorities) {
    const ctx = document.getElementById('priorityChart').getContext('2d');
    
    const data = {
        low: priorities.low || 0,
        medium: priorities.medium || 0,
        high: priorities.high || 0
    };
    
    if (charts.priority) {
        charts.priority.data.datasets[0].data = [data.low, data.medium, data.high];
        charts.priority.update('active');
    } else {
        charts.priority = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['–ù–∏–∑–∫–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–í—ã—Å–æ–∫–∏–π'],
                datasets: [{
                    data: [data.low, data.medium, data.high],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.6)',
                        'rgba(251, 191, 36, 0.6)',
                        'rgba(239, 68, 68, 0.6)'
                    ],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-secondary'),
                            stepSize: 1,
                            font: { size: 10 }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-secondary'),
                            font: { size: 10 },
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
}

// –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
function updateProductivityChart(productivity) {
    const ctx = document.getElementById('productivityChart').getContext('2d');
    
    const labels = productivity.map(p => p.period);
    const data = productivity.map(p => p.count);
    
    if (charts.productivity) {
        charts.productivity.data.labels = labels;
        charts.productivity.data.datasets[0].data = data;
        charts.productivity.update('active');
    } else {
        charts.productivity = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á',
                    data: data,
                    borderColor: 'rgba(96, 165, 250, 1)',
                    backgroundColor: 'rgba(96, 165, 250, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-secondary'),
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
}

// –¢–æ–ø –ø–µ—Ä–∏–æ–¥–æ–≤
function updateTopPeriods(periods) {
    const container = document.getElementById('topPeriodsList');
    
    if (periods.length === 0) {
        container.innerHTML = '<div class="empty-message">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        return;
    }
    
    container.innerHTML = periods.map((p, i) => `
        <div class="top-item">
            <span class="top-rank">${i + 1}</span>
            <span class="top-period">${p.period}</span>
            <span class="top-count">${p.count} –∑–∞–¥–∞—á</span>
        </div>
    `).join('');
}

// –°–º–µ–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞
function changePeriod(period) {
    currentPeriod = period;
    
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
    });
    
    loadStats(period);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
function toggleAddForm() {
    const panel = document.getElementById('addTaskPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á
function toggleSubtasks() {
    const container = document.getElementById('subtasksContainer');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

// –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
let subtaskCount = 3;
function addSubtaskInput() {
    const list = document.getElementById('subtasksList');
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-input subtask-input';
    input.placeholder = `–ü–æ–¥–∑–∞–¥–∞—á–∞ ${subtaskCount}`;
    list.appendChild(input);
    subtaskCount++;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
function setupFormHandler() {
    document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const subtasks = Array.from(document.querySelectorAll('.subtask-input'))
            .map(input => input.value.trim())
            .filter(val => val);
        
        const data = {
            title: formData.get('title'),
            description: formData.get('description'),
            priority: formData.get('priority'),
            deadline: formData.get('deadline') || null,
            subtasks: subtasks
        };
        
        try {
            const response = await fetch('/api/task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                e.target.reset();
                toggleAddForm();
                await loadTasks();
                await loadStats(currentPeriod);
            }
        } catch (error) {
            console.error('Error adding task:', error);
        }
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∑–∞–¥–∞—á—É
async function toggleTask(id) {
    try {
        await fetch(`/api/task/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'toggle' })
        });
        await loadTasks();
        await loadStats(currentPeriod);
    } catch (error) {
        console.error('Error toggling task:', error);
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É
async function toggleSubtask(id) {
    try {
        await fetch(`/api/task/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'toggle_subtask' })
        });
        await loadTasks();
        await loadStats(currentPeriod);
    } catch (error) {
        console.error('Error toggling subtask:', error);
    }
}

// –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É
async function deleteTask(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) return;
    
    try {
        await fetch(`/api/task/${id}`, { method: 'DELETE' });
        await loadTasks();
        await loadStats(currentPeriod);
    } catch (error) {
        console.error('Error deleting task:', error);
    }
}

// –£—Ç–∏–ª–∏—Ç—ã
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function getPriorityLabel(priority) {
    const labels = { low: 'üü¢ –ù–∏–∑–∫–∏–π', medium: 'üü° –°—Ä–µ–¥–Ω–∏–π', high: 'üî¥ –í—ã—Å–æ–∫–∏–π' };
    return labels[priority] || labels.medium;
}

function getProgressPercent(subtasks) {
    const completed = subtasks.filter(s => s.status === 'done').length;
    return (completed / subtasks.length * 100).toFixed(0);
}

function getCompletedCount(subtasks) {
    return subtasks.filter(s => s.status === 'done').length;
}
</script>
{% endblock %}